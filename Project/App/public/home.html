<!DOCTYPE html>
<html lang="en">

<head>
    <title>Final Year Project</title>
    <link rel="manifest" href="scripts/fyp.webmanifest">
    <link rel="apple-touch-icon" href="images/global-512.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Offline map application made by Adil Mushtaq (Devqui) as a part of their final year project">
    <meta name="theme-color" content="#764ABC">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        html {
            height: 100%;
        }

        body {
            height: calc(100% - 4em);
        }

        #navbar {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 1;
            width: 100%;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            border-bottom: 1px solid #e7e7e7;
            background-color: #f3f3f3;
        }

        li {
            float: left;
        }

        li:last-child {
            border-right: none;
        }

        li a {
            display: block;
            color: #666;
            padding: 1em 1em;
            text-align: center;
            text-decoration: none;
        }

        li b {
            display: block;
            color: #666;
            text-align: center;
            padding: 1em 1em;
            text-decoration: none;
            font-size: 1em;
        }

        li a:hover {
            background-color: #ddd;
        }

        li button {
            padding: 0;
            border: none;
            background: none;
        }

        li img {
            height: 1rem;
            padding: 1em 1em;
            width: auto;
            margin: 0;
            border: none;
        }

        #map {
            height: calc(100vh - 4em);
            width: 100%;
            z-index: 0;
        }
    </style>
    <script src="scripts/fyp.js"></script>
</head>

<body>
    <ul id="navbar">
        <li>
            <b href="/">Offline Web App</b>
        </li>
        <li style="float:right">
            <a href="#">Login</a>
        </li>
    </ul>
    <script src="scripts/initDB.js"></script>
    <div id="map"></div>
</body>
<script>
    var map = L.map('map', { zoomControl: false });
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    map.setView([51.505, -0.09], 13)
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    const locOptions = {
        enableHighAccuracy: true,
        timeout: 5000
    }

    const searchOptions = {
        stroke: false,
        fill: false
    }

    navigator.geolocation.watchPosition(success, error, locOptions)

    let user, acc, zoomed, search;

    function success(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        if (user) {
            map.removeLayer(user);
            map.removeLayer(acc);
        }

        user = L.marker([lat, lng]).addTo(map);
        acc = L.circle([lat, lng], { radius: accuracy }).addTo(map);

        if (!zoomed) {
            zoomed = map.fitBounds(acc.getBounds())
        }

        map.setView([lat, lng]);
    }

    function error(err) {
        if (err.code === 1) {
            alert("Please enable location access");
        } else {
            alert("Cannot get current location");
        }
    }

    var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false
    })
        .on('markgeocode', function (e) {
            if (search) {
                map.removeLayer(search);
            }
            var bbox = e.geocode.bbox;
            search = L.polygon([
                bbox.getSouthEast(),
                bbox.getNorthEast(),
                bbox.getNorthWest(),
                bbox.getSouthWest()
            ], searchOptions).addTo(map);
            map.fitBounds(search.getBounds());

        })
        .addTo(map);
</script>

</html>